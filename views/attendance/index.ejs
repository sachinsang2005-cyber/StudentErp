<% layout('layout') -%>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2 text-primary">
    <i class="bi bi-calendar-check me-2"></i>Attendance Management
  </h1>
  <div class="d-flex gap-2">
    <input 
      type="date" 
      class="form-control" 
      id="attendanceDate" 
      value="<%= selectedDate %>"
      onchange="changeDate()"
    >
  </div>
</div>

<div class="card border-0 shadow-sm rounded-4">
  <div class="card-header bg-white border-0 pt-4">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        Attendance for <%= new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
      </h5>
      <button class="btn btn-success" onclick="markAttendance()">
        <i class="bi bi-check-circle me-2"></i>Save Attendance
      </button>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="attendanceTable">
        <thead class="table-light">
          <tr>
            <th class="border-0">Roll No</th>
            <th class="border-0">Name</th>
            <th class="border-0">Class</th>
            <th class="border-0 text-center">Present</th>
            <th class="border-0 text-center">Absent</th>
          </tr>
        </thead>
        <tbody>
          <% if (students && students.length > 0) { %>
            <% students.forEach(student => { %>
              <tr>
                <td class="fw-bold text-primary"><%= student.roll_no %></td>
                <td><%= student.name %></td>
                <td>
                  <span class="badge bg-light text-dark"><%= student.class %></span>
                </td>
                <td class="text-center">
                  <input 
                    type="radio" 
                    class="form-check-input" 
                    name="attendance_<%= student.id %>" 
                    value="Present" 
                    data-student-id="<%= student.id %>"
                    <%= student.attendance && student.attendance[0] && student.attendance[0].status === 'Present' ? 'checked' : '' %>
                  >
                </td>
                <td class="text-center">
                  <input 
                    type="radio" 
                    class="form-check-input" 
                    name="attendance_<%= student.id %>" 
                    value="Absent" 
                    data-student-id="<%= student.id %>"
                    <%= student.attendance && student.attendance[0] && student.attendance[0].status === 'Absent' ? 'checked' : '' %>
                  >
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="5" class="text-center text-muted py-4">
                <i class="bi bi-inbox display-4 d-block mb-2"></i>
                No students found. Add students first to mark attendance.
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
function changeDate() {
  const selectedDate = document.getElementById('attendanceDate').value;
  window.location.href = `/attendance?date=${selectedDate}`;
}

async function markAttendance() {
  const attendanceData = [];
  const radios = document.querySelectorAll('input[type="radio"]:checked');
  
  radios.forEach(radio => {
    attendanceData.push({
      student_id: radio.dataset.studentId,
      status: radio.value
    });
  });

  if (attendanceData.length === 0) {
    alert('Please mark attendance for at least one student');
    return;
  }

  try {
    const response = await fetch('/attendance/mark', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        attendanceData: JSON.stringify(attendanceData),
        date: document.getElementById('attendanceDate').value
      })
    });

    const result = await response.json();
    
    if (result.success) {
      alert('Attendance marked successfully!');
      location.reload();
    } else {
      alert('Error: ' + result.error);
    }
  } catch (error) {
    alert('An error occurred while marking attendance');
  }
}
</script>